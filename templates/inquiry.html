{% extends "layout.html" %}
{% block title %}Inquiry{% endblock %}

{% block main %}
<div class="page-container">
    <div class="inquiry-details fade-element">
        <h2 class="h2">{{inquiry.request}}</h2>
        <p>Expires: {{inquiry.exp_date}}</p>
    </div>

    {% if not is_owner %}
    <div class="response-container fade-element">
        <form action="{{ url_for('inquiry', inquiry_id=inquiry.id) }}" method="post" enctype="multipart/form-data" class="response-form">
            <div class="mb-3">
                <textarea class="form-control" name="replyResponse" placeholder="Describe your item" required></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label">Upload a picture</label>
                <input class="form-control" name="replyPic" type="file" accept="image/*" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Return by date</label>
                <input class="form-control" name="lending_exp_date" type="date" required>
            </div>
            <button class="btn-primary" type="submit">Submit Response</button>
        </form>
    </div>
    {% endif %}

    {% if responses %}
    <div class="responses-container" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin: 0 auto;">
        {% for response in responses %}
        <div class="response-card fade-element" style="flex: 0 0 calc(45% - 10px); min-width: 300px;" id="reply-{{ response.id }}">
            <div class="response-header">
                <h3>{{ response.lender_username }}</h3>
                <p class="response-date">Return by: {{ response.lending_exp_date }}</p>
            </div>
            <p class="response-text">{{ response.reply }}</p>
            {% if response.img_path %}
            <div class="response-image">
                <img src="{{ url_for('static', filename=response.img_path) }}" alt="Item Image">
            </div>
            {% endif %}
            {% if is_owner %}
            <div class="response-actions">
                <button class="btn-primary accept-btn" data-id="{{ response.id }}">Accept</button>
                <button class="btn-primary decline-btn" data-id="{{ response.id }}">Decline</button>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    {% if is_owner %}
    <form id="confirm-selection-form" action="{{ url_for('inquiry', inquiry_id=inquiry.id) }}" method="post" class="confirmation-form">
        <button class="btn-primary confirm-accept-btn">Confirm Selection</button>
        <input type="hidden" id="accepted-id-input" name="accepted_id">
        <input type="hidden" id="declined-ids-input" name="declined_ids">
    </form>
    {% endif %}
    {% else %}
        {% if is_owner %}
        <p class="no-responses">No responses yet</p>
        {% endif %}
    {% endif %}
</div>

<style>
.response-container {
    max-width: 800px;
    margin: 20px auto;
    padding: 20px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.response-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.response-image img {
    max-width: 100%;
    border-radius: 8px;
    margin: 10px 0;
}

.response-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.accepted {
    background-color: #4CAF50 !important;
}

.declined {
    background-color: #f44336 !important;
}

.confirmation-form {
    text-align: center;
    margin: 20px 0;
}

@media (max-width: 768px) {
    .response-card {
        flex: 0 0 100% !important;
    }
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
    let acceptedReplyId = null;
    let to_be_deleted = new Set();

    document.querySelectorAll(".response-card").forEach(card => {
        let id_for_sql = card.id.replace('reply-', '');
        const acceptBtn = card.querySelector(".accept-btn");
        const declineBtn = card.querySelector(".decline-btn");

        if (acceptBtn) {
            acceptBtn.addEventListener("click", () => {
                to_be_deleted.delete(id_for_sql);

                if (acceptedReplyId) {
                    const previousCard = document.querySelector(`#reply-${acceptedReplyId}`);
                    if (previousCard) {
                        const previousAcceptBtn = previousCard.querySelector(".accept-btn");
                        const previousDeclineBtn = previousCard.querySelector(".decline-btn");
                        previousAcceptBtn.classList.remove("accepted");
                        previousDeclineBtn.classList.remove("declined");
                    }
                }
                
                acceptedReplyId = id_for_sql;
                acceptBtn.classList.add("accepted");
                declineBtn.classList.remove("declined");
            });
        }

        if (declineBtn) {
            declineBtn.addEventListener("click", () => {
                declineBtn.classList.add("declined");
                
                if (acceptedReplyId === id_for_sql) {
                    acceptBtn.classList.remove("accepted");
                    acceptedReplyId = null;
                }

                to_be_deleted.add(id_for_sql);
            });
        }
    });

    const form = document.getElementById("confirm-selection-form");
    if (form) {
        form.addEventListener("submit", (event) => {
            const declinedIdsInput = document.getElementById("declined-ids-input");
            declinedIdsInput.value = Array.from(to_be_deleted).join(',');

            const acceptedIdInput = document.getElementById("accepted-id-input");
            acceptedIdInput.value = acceptedReplyId;
            
            if (!acceptedReplyId && to_be_deleted.size === 0) {
                event.preventDefault();
                alert("Please select something before confirming!");
            }
        });
    }
});
</script>
{% endblock %}