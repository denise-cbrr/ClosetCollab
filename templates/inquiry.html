{% extends "layout.html" %}
{% block title %}
    Inquiries
{% endblock %}

{% block main %}
    <h3>{{inquiry.request}}</h3>
    <h2>Expiration Date: {{inquiry.exp_date}}</h2>
    <!-- Button trigger modal (just something random from bootstrap) -->
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
        Have an item to lend out?
    </button>
    
    <!-- Modal -->
    <!-- Creates form for users to add responses to -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Add an inquiry!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{{ url_for('inquiry', inquiry_id=inquiry.id) }}" method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <input class="form-control mx-auto w-auto" name="replyResponse" placeholder="Describe your item" type="text" required>
                        <p>Upload a picture!</p>
                            <input name="replyPic" placeholder="Image: " type="file" accept="image/*" required >
                    </div>
                    <button class="btn btn-primary" type="submit">Submit here!</button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
        </div>
    </div>
    {% for response in responses %}
        <!-- Im not sure why the code doesn't let me store it without the "reply-"-->
        <div class = "reply_card" id="reply-{{ response.id }}">
            <p>{{response.lender_username}}: {{response.reply}}</p>
            <h3>Uploaded Image:</h3>
            <img src="{{ response.img_path }}" alt="Item Image" style="max-width: 200px;">
            <!-- Only shows buttons if the current user is viewing their own inquiries-->
            {% if is_owner %}
                <button class="accept-btn" data-id="{{ response.id }}">Accept</button>
                <button class="decline-btn" data-id="{{ response.id }}">Decline</button>
            {% endif %}
        </div>
    {% endfor %}

    <!-- we could create a pop up that asks the user to verify that they understand, and then there's an option for users to say "don't show up again" but that can be a less important thing-->
    {% if is_owner %}
        <form id="confirm-selection-form" action="{{ url_for('inquiry', inquiry_id=inquiry.id) }}" method="post">
            <button class="confirm-accept-btn">Confirm your selection! (Please note, you will not be able to change this)</button>
            <p>Accepted Reply ID: {{ acceptedReplyId }}</p>
            <input type="hidden" id="accepted-id-input" name="accepted_id" value="">
            <input type="hidden" id="declined-ids-input" name="declined_ids" value="">
        </form>
    {% endif %}

    <script>
        // Refreshes on every reload
         document.addEventListener("DOMContentLoaded", () => {
            // ID of the reply that is currently accepted (set null originally when site first loads)
            let acceptedReplyId = null; 

            // Will store all the responses we'll need to delete in the sql (aka the user doesn't want them)
            let to_be_deleted = new Set();

            document.querySelectorAll(".reply_card").forEach(card => {
                let id_for_sql = card.id.replace('reply-', '');
                const acceptBtn = card.querySelector(".accept-btn");
                const declineBtn = card.querySelector(".decline-btn");

                // Updates what's the current selected reply id when a "accept" button is clicked
                acceptBtn.addEventListener("click", () => {
                    // Checks if this card had been declined, and if it has, remove it from that list because the user now intends to accept it
                    to_be_deleted.delete(id_for_sql);

                    // If there was something selected before it:
                    if (acceptedReplyId) {
                        // identify what was previously selected and replaces it
                        const previousCard = document.querySelector(`#${acceptedReplyId}`);
                        if (previousCard) {
                            const previousAcceptBtn = previousCard.querySelector(".accept-btn");
                            const previousDeclineBtn = previousCard.querySelector(".decline-btn");

                            // previousDeclineBtn.disabled = false;

                            previousAcceptBtn.classList.remove("accepted");
                            previousDeclineBtn.classList.remove("declined");
                        }
                    }
                    // Set new accepted reply
                    acceptedReplyId = id_for_sql;

                    // Adds color (green for selected)
                    acceptBtn.classList.add("accepted"); 

                    // Removes any red coloring just in case there was one from before
                    declineBtn.classList.remove("declined"); 
                })

                declineBtn.addEventListener("click", () => {
                    const selected_reply = card.id;
                    
                    // Adds red color
                    declineBtn.classList.add("declined"); 

                    // Checks if this response was "accepted" before, and if it has, change it so that it now has declined status
                    if (acceptedReplyId === card.id){
                        acceptBtn.classList.remove("accepted");
                        acceptedReplyId = null; 
                    }

                    // Add this card's id as one that needs to be deleted
                    to_be_deleted.add(id_for_sql);

                    //console.log("to_be_deleted:", Array.from(to_be_deleted));
                })
            })

            // Turn to_be_deleted into an array, for the backend to process
            const form = document.getElementById("confirm-selection-form");
            form.addEventListener("submit", (event) => {
                const declinedIdsInput = document.getElementById("declined-ids-input");
                // Turn set into array
                declinedIdsInput.value = Array.from(to_be_deleted).join(',');

                const acceptedIdInput = document.getElementById("accepted-id-input");
                acceptedIdInput.value = acceptedReplyId;
                
                // Alerts user that they cannot submit unless they either decline something or/and accept something
                if (!acceptedReplyId && to_be_deleted.size === 0) {
                    event.preventDefault();
                    alert("Please select something before confirming!");
                }
            })
         })
    </script>
    
{% endblock %}


